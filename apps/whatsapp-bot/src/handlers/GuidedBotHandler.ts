// import { Client, Message, Buttons, List } from 'whatsapp-web.js';
// import { Conversation, Product, Order, Customer } from '../models';

// export class GuidedBotHandler {
//   private client: Client;

//   constructor(client: Client) {
//     this.client = client;
//   }

//   async handleMessage(msg: Message) {
//     const phone = msg.from;
    
//     // Obtener o crear conversaci√≥n
//     let conversation = await Conversation.findOne({ phone });
//     if (!conversation) {
//       conversation = await Conversation.create({
//         phone,
//         step: 'welcome',
//         cart: [],
//       });
//     }

//     // Actualizar √∫ltima actividad
//     conversation.lastMessageAt = new Date();

//     // Procesar seg√∫n el paso actual
//     switch (conversation.step) {
//       case 'welcome':
//         await this.sendWelcome(msg, conversation);
//         break;

//       case 'browsing':
//         await this.handleBrowsing(msg, conversation);
//         break;

//       case 'viewing_product':
//         await this.handleProductView(msg, conversation);
//         break;

//       case 'adding_to_cart':
//         await this.handleAddToCart(msg, conversation);
//         break;

//       case 'viewing_cart':
//         await this.handleCartView(msg, conversation);
//         break;

//       case 'checkout':
//         await this.handleCheckout(msg, conversation);
//         break;

//       case 'awaiting_address':
//         await this.handleAddress(msg, conversation);
//         break;

//       case 'payment_method':
//         await this.handlePaymentMethod(msg, conversation);
//         break;

//       case 'awaiting_yape_proof':
//         await this.handleYapeProof(msg, conversation);
//         break;

//       case 'completed':
//         await this.handleCompleted(msg, conversation);
//         break;

//       default:
//         await this.sendWelcome(msg, conversation);
//     }

//     await conversation.save();
//   }

//   // ==========================================
//   // PASO 1: BIENVENIDA
//   // ==========================================
//   async sendWelcome(msg: Message, conversation: any) {
//     const buttons = new Buttons(
//       'üëã *¬°Bienvenido a nuestra tienda!*\n\n' +
//       '¬øQu√© te gustar√≠a hacer hoy?',
//       [
//         { body: 'üõçÔ∏è Ver cat√°logo' },
//         { body: 'üõí Mi carrito' },
//         { body: 'üì¶ Mis pedidos' }
//       ],
//       '¬°Elige una opci√≥n!'
//     );

//     await this.client.sendMessage(msg.from, buttons);
//     conversation.step = 'browsing';
//   }

//   // ==========================================
//   // PASO 2: NAVEGACI√ìN (con Listas)
//   // ==========================================
//   async handleBrowsing(msg: Message, conversation: any) {
//     const text = msg.body.toLowerCase();

//     if (text.includes('cat√°logo') || text.includes('catalogo')) {
//       await this.sendCatalogCategories(msg);
//     } else if (text.includes('carrito')) {
//       conversation.step = 'viewing_cart';
//       await this.showCart(msg, conversation);
//     } else if (text.includes('pedidos')) {
//       await this.showOrders(msg, conversation);
//     } else {
//       // Si el usuario escribe algo diferente, volver a mostrar opciones
//       await this.sendWelcome(msg, conversation);
//     }
//   }

//   // Enviar categor√≠as como Lista
//   async sendCatalogCategories(msg: Message) {
//     const categories = await this.getCategories();

//     const sections = categories.map(cat => ({
//       title: cat.name,
//       rows: [
//         {
//           id: `cat_${cat.slug}`,
//           title: `Ver ${cat.name}`,
//           description: `${cat.productCount} productos disponibles`
//         }
//       ]
//     }));

//     const list = new List(
//       'üõçÔ∏è *CAT√ÅLOGO DE PRODUCTOS*\n\n' +
//       'Selecciona una categor√≠a para ver los productos:',
//       'Ver categor√≠as',
//       sections,
//       '¬°Elige una categor√≠a!'
//     );

//     await this.client.sendMessage(msg.from, list);
//   }

//   // ==========================================
//   // PASO 3: VER PRODUCTOS DE UNA CATEGOR√çA
//   // ==========================================
//   async handleProductView(msg: Message, conversation: any) {
//     // Usuario seleccion√≥ una categor√≠a desde la lista
//     const selectedId = msg.selectedRowId || msg.body;

//     if (selectedId.startsWith('cat_')) {
//       const categorySlug = selectedId.replace('cat_', '');
//       await this.sendProductsInCategory(msg, categorySlug, conversation);
//     } else if (selectedId.startsWith('prod_')) {
//       const productId = selectedId.replace('prod_', '');
//       await this.sendProductDetails(msg, productId, conversation);
//     } else {
//       // Volver al men√∫
//       await this.sendWelcome(msg, conversation);
//     }
//   }

//   // Enviar productos de una categor√≠a
//   async sendProductsInCategory(msg: Message, category: string, conversation: any) {
//     const products = await Product.find({ 
//       categories: category,
//       isActive: true,
//       stock: { $gt: 0 }
//     }).limit(10);

//     if (products.length === 0) {
//       await msg.reply('No hay productos disponibles en esta categor√≠a.');
//       await this.sendWelcome(msg, conversation);
//       return;
//     }

//     const sections = [{
//       title: 'Productos disponibles',
//       rows: products.map(p => ({
//         id: `prod_${p._id}`,
//         title: p.name,
//         description: `S/ ${p.price} - Stock: ${p.stock}`
//       }))
//     }];

//     // Agregar opci√≥n para volver
//     sections.push({
//       title: 'Otras opciones',
//       rows: [
//         {
//           id: 'back_categories',
//           title: '‚¨ÖÔ∏è Volver a categor√≠as',
//           description: 'Ver otras categor√≠as'
//         },
//         {
//           id: 'view_cart',
//           title: 'üõí Ver mi carrito',
//           description: `${conversation.cart?.length || 0} productos`
//         }
//       ]
//     });

//     const list = new List(
//       `üì¶ *Productos en ${category}*\n\n` +
//       'Selecciona un producto para ver detalles:',
//       'Ver productos',
//       sections,
//       'Cat√°logo'
//     );

//     await this.client.sendMessage(msg.from, list);
//     conversation.step = 'viewing_product';
//   }

//   // Detalles de producto con botones
//   async sendProductDetails(msg: Message, productId: string, conversation: any) {
//     const product = await Product.findById(productId);

//     if (!product) {
//       await msg.reply('Producto no encontrado.');
//       return;
//     }

//     // Guardar producto actual en conversaci√≥n
//     conversation.tempData = { currentProductId: productId };

//     let message = `üì¶ *${product.name}*\n\n`;
//     message += `${product.description}\n\n`;
//     message += `üí∞ *Precio:* S/ ${product.price}\n`;
//     message += `üì¶ *Stock:* ${product.stock} unidades\n`;
    
//     if (product.images && product.images.length > 0) {
//       // Enviar imagen primero
//       await this.client.sendMessage(msg.from, product.images[0]);
//     }

//     const buttons = new Buttons(
//       message,
//       [
//         { body: '‚ûï Agregar 1' },
//         { body: '‚ûï Agregar 2' },
//         { body: 'üìù Cantidad personalizada' }
//       ],
//       'Agregar al carrito'
//     );

//     await this.client.sendMessage(msg.from, buttons);
//     conversation.step = 'adding_to_cart';
//   }

//   // ==========================================
//   // PASO 4: AGREGAR AL CARRITO
//   // ==========================================
//   async handleAddToCart(msg: Message, conversation: any) {
//     const text = msg.body.toLowerCase();
//     const productId = conversation.tempData?.currentProductId;

//     if (!productId) {
//       await msg.reply('Error: producto no encontrado. Vuelve a seleccionar.');
//       conversation.step = 'browsing';
//       return;
//     }

//     let quantity = 1;

//     if (text.includes('agregar 1')) {
//       quantity = 1;
//     } else if (text.includes('agregar 2')) {
//       quantity = 2;
//     } else if (text.includes('personalizada')) {
//       await msg.reply('¬øCu√°ntas unidades quieres agregar? (escribe un n√∫mero del 1 al 10)');
//       conversation.step = 'awaiting_quantity';
//       return;
//     } else if (!isNaN(Number(text))) {
//       quantity = Math.min(Math.max(parseInt(text), 1), 10);
//     }

//     await this.addToCart(msg, conversation, productId, quantity);
//   }

//   async addToCart(msg: Message, conversation: any, productId: string, quantity: number) {
//     const product = await Product.findById(productId);

//     if (!product || product.stock < quantity) {
//       await msg.reply(`‚ùå No hay suficiente stock. Solo hay ${product?.stock || 0} unidades.`);
//       return;
//     }

//     // Verificar si ya existe en el carrito
//     const existingItem = conversation.cart.find((item: any) => 
//       item.productId.toString() === productId
//     );

//     if (existingItem) {
//       existingItem.quantity += quantity;
//     } else {
//       conversation.cart.push({
//         productId: product._id,
//         name: product.name,
//         price: product.price,
//         quantity,
//       });
//     }

//     await conversation.save();

//     const buttons = new Buttons(
//       `‚úÖ *${product.name}* agregado al carrito\n\n` +
//       `Cantidad: ${quantity}\n` +
//       `Subtotal: S/ ${(product.price * quantity).toFixed(2)}\n\n` +
//       `¬øQu√© deseas hacer?`,
//       [
//         { body: 'üõçÔ∏è Seguir comprando' },
//         { body: 'üõí Ver carrito' },
//         { body: 'üí≥ Proceder al pago' }
//       ],
//       'Carrito'
//     );

//     await this.client.sendMessage(msg.from, buttons);
//     conversation.step = 'viewing_cart';
//   }

//   // ==========================================
//   // PASO 5: VER CARRITO
//   // ==========================================
//   async showCart(msg: Message, conversation: any) {
//     if (!conversation.cart || conversation.cart.length === 0) {
//       const buttons = new Buttons(
//         'üõí Tu carrito est√° vac√≠o\n\n¬øQuieres explorar productos?',
//         [{ body: 'üõçÔ∏è Ver cat√°logo' }],
//         'Carrito vac√≠o'
//       );
//       await this.client.sendMessage(msg.from, buttons);
//       conversation.step = 'browsing';
//       return;
//     }

//     let total = 0;
//     let cartText = 'üõí *TU CARRITO*\n\n';

//     conversation.cart.forEach((item: any) => {
//       const subtotal = item.price * item.quantity;
//       total += subtotal;
//       cartText += `‚Ä¢ ${item.name}\n`;
//       cartText += `  ${item.quantity} x S/ ${item.price} = S/ ${subtotal.toFixed(2)}\n\n`;
//     });

//     cartText += `\nüí∞ *TOTAL: S/ ${total.toFixed(2)}*\n\n`;
//     cartText += '¬øQu√© deseas hacer?';

//     const buttons = new Buttons(
//       cartText,
//       [
//         { body: 'üõçÔ∏è Seguir comprando' },
//         { body: 'üóëÔ∏è Vaciar carrito' },
//         { body: '‚úÖ Proceder al pago' }
//       ],
//       'Carrito'
//     );

//     await this.client.sendMessage(msg.from, buttons);
//     conversation.step = 'checkout';
//   }

//   // ==========================================
//   // PASO 6: CHECKOUT
//   // ==========================================
//   async handleCheckout(msg: Message, conversation: any) {
//     const text = msg.body.toLowerCase();

//     if (text.includes('seguir comprando') || text.includes('cat√°logo')) {
//       conversation.step = 'browsing';
//       await this.sendCatalogCategories(msg);
//     } else if (text.includes('vaciar')) {
//       conversation.cart = [];
//       await conversation.save();
//       await msg.reply('üóëÔ∏è Carrito vaciado.');
//       await this.sendWelcome(msg, conversation);
//     } else if (text.includes('pago') || text.includes('proceder')) {
//       conversation.step = 'awaiting_address';
//       await msg.reply(
//         'üìç *Direcci√≥n de env√≠o*\n\n' +
//         'Por favor, escribe tu direcci√≥n completa para el env√≠o.\n\n' +
//         '_Ejemplo: Jr. Las Flores 123, San Isidro, Lima_'
//       );
//     }
//   }

//   // ==========================================
//   // PASO 7: DIRECCI√ìN
//   // ==========================================
//   async handleAddress(msg: Message, conversation: any) {
//     const address = msg.body.trim();

//     if (address.length < 10) {
//       await msg.reply('‚ö†Ô∏è Por favor, escribe una direcci√≥n completa.');
//       return;
//     }

//     conversation.tempData = {
//       ...conversation.tempData,
//       address,
//     };

//     const total = conversation.cart.reduce((sum: number, item: any) => 
//       sum + (item.price * item.quantity), 0
//     );

//     const buttons = new Buttons(
//       `‚úÖ Direcci√≥n guardada\n\n` +
//       `üìç ${address}\n\n` +
//       `üí∞ Total a pagar: S/ ${total.toFixed(2)}\n\n` +
//       `Selecciona tu m√©todo de pago:`,
//       [
//         { body: 'üí≥ Tarjeta (Culqi)' },
//         { body: 'üì± Yape' },
//         { body: 'üíµ Pago en efectivo' }
//       ],
//       'M√©todo de pago'
//     );

//     await this.client.sendMessage(msg.from, buttons);
//     conversation.step = 'payment_method';
//   }

//   // ==========================================
//   // PASO 8: M√âTODO DE PAGO
//   // ==========================================
//   async handlePaymentMethod(msg: Message, conversation: any) {
//     const text = msg.body.toLowerCase();

//     // Crear orden primero
//     const order = await this.createOrder(conversation);

//     if (text.includes('tarjeta') || text.includes('culqi')) {
//       await this.sendCulqiLink(msg, conversation, order);
//     } else if (text.includes('yape')) {
//       await this.requestYapeProof(msg, conversation, order);
//     } else if (text.includes('efectivo')) {
//       await this.handleCashPayment(msg, conversation, order);
//     }
//   }

//   async createOrder(conversation: any): Promise<any> {
//     const customer = await Customer.findOneAndUpdate(
//       { phone: conversation.phone },
//       { phone: conversation.phone, lastInteraction: new Date() },
//       { upsert: true, new: true }
//     );

//     const total = conversation.cart.reduce((sum: number, item: any) => 
//       sum + (item.price * item.quantity), 0
//     );

//     const order = await Order.create({
//       orderNumber: `ORD-${Date.now()}`,
//       customer: customer._id,
//       items: conversation.cart,
//       total,
//       currency: 'PEN',
//       status: 'pending',
//       payment: {
//         status: 'processing'
//       }
//     });

//     conversation.tempData = {
//       ...conversation.tempData,
//       orderId: order._id.toString()
//     };

//     return order;
//   }

//   async sendCulqiLink(msg: Message, conversation: any, order: any) {
//     // Aqu√≠ integrar√≠as con Culqi
//     const paymentLink = `https://checkout.culqi.com/...`;

//     await msg.reply(
//       `üí≥ *Link de pago generado*\n\n` +
//       `Pedido: ${order.orderNumber}\n` +
//       `Monto: S/ ${order.total.toFixed(2)}\n\n` +
//       `${paymentLink}\n\n` +
//       `Haz clic en el link para pagar de forma segura.`
//     );

//     conversation.step = 'completed';
//   }

//   async requestYapeProof(msg: Message, conversation: any, order: any) {
//     await msg.reply(
//       `üì± *Pago con Yape*\n\n` +
//       `Pedido: ${order.orderNumber}\n` +
//       `Monto: S/ ${order.total.toFixed(2)}\n\n` +
//       `Realiza tu Yape al n√∫mero: *999 999 999*\n\n` +
//       `Luego env√≠a la captura de pantalla del comprobante.`
//     );

//     conversation.step = 'awaiting_yape_proof';
//   }

//   async handleCashPayment(msg: Message, conversation: any, order: any) {
//     order.payment.method = 'cash';
//     order.status = 'confirmed';
//     await order.save();

//     await msg.reply(
//       `‚úÖ *Pedido confirmado*\n\n` +
//       `Pedido: ${order.orderNumber}\n` +
//       `Total: S/ ${order.total.toFixed(2)}\n` +
//       `Pago: Efectivo contra entrega\n\n` +
//       `Tu pedido ser√° entregado en 24-48 horas.\n` +
//       `Te notificaremos cuando est√© en camino.`
//     );

//     conversation.cart = [];
//     conversation.step = 'completed';
//   }

//   // ==========================================
//   // PASO 9: RECIBIR COMPROBANTE YAPE
//   // ==========================================
//   async handleYapeProof(msg: Message, conversation: any) {
//     if (!msg.hasMedia) {
//       await msg.reply('Por favor, env√≠a la imagen del comprobante de Yape.');
//       return;
//     }

//     const media = await msg.downloadMedia();
//     // Guardar imagen y marcar orden como pendiente de verificaci√≥n

//     const orderId = conversation.tempData?.orderId;
//     const order = await Order.findById(orderId);

//     if (order) {
//       order.payment.method = 'yape';
//       order.payment.status = 'pending_verification';
//       // Aqu√≠ guardar√≠as la imagen en S3/Cloudinary
//       await order.save();
//     }

//     await msg.reply(
//       `‚úÖ Comprobante recibido\n\n` +
//       `Estamos verificando tu pago. Te confirmaremos en los pr√≥ximos minutos.\n\n` +
//       `N√∫mero de pedido: ${order?.orderNumber}`
//     );

//     conversation.cart = [];
//     conversation.step = 'completed';
//   }

//   // ==========================================
//   // HELPERS
//   // ==========================================
//   async handleCompleted(msg: Message, conversation: any) {
//     await this.sendWelcome(msg, conversation);
//   }

//   async showOrders(msg: Message, conversation: any) {
//     const customer = await Customer.findOne({ phone: conversation.phone });
//     if (!customer) {
//       await msg.reply('No tienes pedidos anteriores.');
//       return;
//     }

//     const orders = await Order.find({ customer: customer._id })
//       .sort({ createdAt: -1 })
//       .limit(5);

//     if (orders.length === 0) {
//       await msg.reply('No tienes pedidos anteriores.');
//       return;
//     }

//     let ordersText = 'üì¶ *TUS √öLTIMOS PEDIDOS*\n\n';
//     orders.forEach(order => {
//       ordersText += `‚Ä¢ ${order.orderNumber}\n`;
//       ordersText += `  S/ ${order.total.toFixed(2)} - ${order.status}\n`;
//       ordersText += `  ${order.createdAt.toLocaleDateString()}\n\n`;
//     });

//     await msg.reply(ordersText);
//   }

//   async getCategories() {
//     const products = await Product.find({ isActive: true });
//     const categoriesMap = new Map();

//     products.forEach(p => {
//       p.categories.forEach((cat: string) => {
//         if (!categoriesMap.has(cat)) {
//           categoriesMap.set(cat, { name: cat, slug: cat.toLowerCase(), productCount: 0 });
//         }
//         categoriesMap.get(cat).productCount++;
//       });
//     });

//     return Array.from(categoriesMap.values());
//   }
// }